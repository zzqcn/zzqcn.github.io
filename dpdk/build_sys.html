

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>9. 编译系统 &mdash; zzq&#39;s blog</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/my_theme.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="zzq&#39;s blog" href="../index.html"/>
        <link rel="up" title="DPDK" href="index.html"/>
        <link rel="next" title="网络算法学" href="../netalgo/index.html"/>
        <link rel="prev" title="8. Mbuf" href="mbuf.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> zzqblog
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">DPDK</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="eal.html">1. EAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="ring.html">2. Ring</a></li>
<li class="toctree-l2"><a class="reference internal" href="mem.html">3. Memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="memseg.html">4. Memseg</a></li>
<li class="toctree-l2"><a class="reference internal" href="memzone.html">5. Memzone</a></li>
<li class="toctree-l2"><a class="reference internal" href="malloc.html">6. Malloc</a></li>
<li class="toctree-l2"><a class="reference internal" href="mempool.html">7. Mempool</a></li>
<li class="toctree-l2"><a class="reference internal" href="mbuf.html">8. Mbuf</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">9. 编译系统</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">9.1. 概述</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">9.2. 源码组织</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#config">9.2.1. config</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mk">9.2.2. mk</a></li>
<li class="toctree-l4"><a class="reference internal" href="#drivers">9.2.3. drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#lib">9.2.4. lib</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tools">9.2.5. tools</a></li>
<li class="toctree-l4"><a class="reference internal" href="#app">9.2.6. app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#examples">9.2.7. examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id5">9.3. 编译系统</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dpdk">9.3.1. 编译dpdk</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">9.3.2. 编译外部程序</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dpdk-makefile">9.4. dpdk Makefile介绍</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id7">9.4.1. 一般规则</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">9.4.2. 类型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">9.4.3. 常用变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#makefile">9.4.4. 仅可以在Makefile中设置的变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">9.4.5. 仅可以在命令行中设置的变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">9.4.6. 可以在Makefile或命令行中设置的变量</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#root-makefile-help">9.5. 根Makefile介绍</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#config-target">9.5.1. config target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#build-target">9.5.2. build target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#install-target">9.5.3. install target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-target">9.5.4. test target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#target">9.5.5. 文档target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deps-target">9.5.6. deps target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">9.5.7. 杂项target</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">9.5.8. 其他命令行变量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debug">9.5.9. 编译Debug版本</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#abi">9.6. ABI管理</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id19">9.6.1. 什么是ABI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dpdk-abi">9.6.2. DPDK ABI策略</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">9.6.3. ABI宏及示例</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">9.6.4. 验证ABI</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#v16-07-2">9.7. 实例：将v16.07.2编译为单个动态库</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#config-common-base">9.7.1. config/common_base</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mk-rte-lib-mk">9.7.2. mk/rte.lib.mk</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mk-rte-combinedlib-mk">9.7.3. mk/rte.combinedlib.mk</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mk-rte-app-mk">9.7.4. mk/rte.app.mk</a></li>
<li class="toctree-l4"><a class="reference internal" href="#libdpdk-map">9.7.5. libdpdk.map</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id22">9.8. 参考</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../netalgo/index.html">网络算法学</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wireshark/index.html">wireshark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../perf/index.html">性能优化</a></li>
<li class="toctree-l1"><a class="reference internal" href="../asm/index.html">汇编语言</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">工具与杂项</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hobby/index.html">兴趣爱好</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">zzqblog</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">DPDK</a> &raquo;</li>
      
    <li>9. 编译系统</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>9. 编译系统<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h1>
<div class="section" id="id2">
<h2>9.1. 概述<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p>本文主要介绍dpdk的源码组织及编译系统，这些内容对于了解dpdk源码、
根据需要裁剪dpdk功能、编译dpdk本身或基于dpdk的应用程序等都有帮助。</p>
<p>文后给出了对dpdk编译系统进行修改以达成某些特定需求的实例。</p>
</div>
<div class="section" id="id3">
<h2>9.2. 源码组织<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<p>dpdk源码包可以在 <a class="reference external" href="http://www.dpdk.org/download">dpdk.org</a> 下载。2.2版本后，版本号直接变为16.04。</p>
<p>git方式获取源码（只读）:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="p">:</span><span class="o">//</span><span class="n">dpdk</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">dpdk</span> <span class="p">,</span> <span class="n">或</span>
<span class="n">git</span> <span class="n">clone</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dpdk</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">git</span><span class="o">/</span><span class="n">dpdk</span>
</pre></div>
</div>
<p>RTE_SDK是编译dpdk之前需要设置的一个环境变量，其值是dpdk源码包解压后的主目录。以下就以&lt;RTE_SDK&gt;表示dpdk源码主目录:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>&lt;RTE_SDK&gt;
├── app           # 一些测试程序
├── buildtools    # XXX
├── config        # 配置文件
├── doc           # rst文档
├── drivers       # 设备驱动程序(poll-mode)
├── examples      # 示例程序
├── GNUmakefile   # Head Makefile for compiling rte SDK
├── lib           # dpdk库
├── LICENSE.GPL
├── LICENSE.LGPL
├── MAINTAINERS   # dpdk维护者信息列表
├── Makefile      # 无用
├── mk            # lib和app的Makefiles
├── pkg           # 软件包相关（？）
├── README        # 简要说明
├── scripts       # 脚本
└── tools         # 辅助工具/脚本
</pre></div>
</div>
<div class="section" id="config">
<h3>9.2.1. config<a class="headerlink" href="#config" title="Permalink to this headline">¶</a></h3>
<p>这里的配置文件用于对不同的编译目标（target）进行配置，包括是否编译某些库，调试选项是否开启等。其中 <code class="docutils literal"><span class="pre">common_base</span></code> 文件非常重要，其中的内容需要非常熟悉。</p>
</div>
<div class="section" id="mk">
<h3>9.2.2. mk<a class="headerlink" href="#mk" title="Permalink to this headline">¶</a></h3>
<p>这里的Makefile文件（后缀.mk）对应多个target、源码种类或编译选项。例如rte.lib.mk用于编译&lt;RTE_SDK&gt;/lib，rte.combinedlib.mk用于将dpddk编译为单个组合库，rte.app.mk用于编译基于dpdk的应用程序。</p>
</div>
<div class="section" id="drivers">
<h3>9.2.3. drivers<a class="headerlink" href="#drivers" title="Permalink to this headline">¶</a></h3>
<p>poll模式的设备驱动源码，例如10GbE，40GbE，PCAP驱动等。</p>
</div>
<div class="section" id="lib">
<h3>9.2.4. lib<a class="headerlink" href="#lib" title="Permalink to this headline">¶</a></h3>
<p>dpdk库源码，每个库一个目录。例如EAL, mbuf, mempool, ring, hash等。</p>
</div>
<div class="section" id="tools">
<h3>9.2.5. tools<a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h3>
<p>一些有用的工具:</p>
<ul class="simple">
<li><strong>cpu_layout.py</strong> 显示JCPU socket/lcore布局信息</li>
<li><strong>dpdk-devbind.py</strong> dpdk设备驱动绑定</li>
<li><strong>dpdk-pmdinfo.py</strong> dump a PMDs hardware support info</li>
<li><strong>dpdk-setup.sh</strong> dpdk编译/配置脚本</li>
</ul>
</div>
<div class="section" id="app">
<h3>9.2.6. app<a class="headerlink" href="#app" title="Permalink to this headline">¶</a></h3>
<p>主要是一些测试程序源码，可用于测试dpdk编译和配置有没有问题。</p>
</div>
<div class="section" id="examples">
<h3>9.2.7. examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>示例程序，对学习如何使用dpdk非常有帮助。见
<a class="reference external" href="http://dpdk.org/doc/guides/sample_app_ug/index.html">文档</a> 。</p>
</div>
</div>
<div class="section" id="id5">
<h2>9.3. 编译系统<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<p>本节描述dpdk所采用的编译系统，以及一些约束条件和机制。</p>
<p>涉及dpdk的编译工作主要有两类：</p>
<ul class="simple">
<li>编译dpdk库和示例程序，编译系统生成头文件，二进制库文件和示例程序</li>
<li>编译外部程序或库，它们使用已安装的dpdk</li>
</ul>
<div class="section" id="dpdk">
<h3>9.3.1. 编译dpdk<a class="headerlink" href="#dpdk" title="Permalink to this headline">¶</a></h3>
<p>在编译dpdk前，需要设置RTE_SDK环境变量，以及&#8221;arch-machine-execenv-toolchain&#8221;组成的编译目标（target）。比如，要使用gcc为x86_64架构native处理器，linux环境编译dpdk，编译目录同target:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export RTE_TARGET=x86_64-native-linuxapp-gcc
cd $RTE_SDK
make config T=$RTE_TARGET O=$RTE_TARGET
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">RTE_TARGET实际上是dpdk编译系统的一个环境变量，应设置成
arch-machine-execenv-toolchain形式，输出目录也应该设置此值，
因为输出目录$(RTE_OUTPUT)默认是build，而编译外部程序时，链接
dpdk的路径是RTE_SDK_BIN=$RTE_SDK/$RTE_TARGET, 如果RTE_OUTPUT
和RTE_TARGET不一致，会发生找不到库的错误. 更多环境变量见X.X节</p>
</div>
<p>完成后，将在&lt;RTE_SDK&gt;生成mybuild子目录，其中包含对应此target的配置文件Makefile等。接着可以进行编译:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>cd $RTE_TARGET
make
</pre></div>
</div>
<p>或者:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>make O=$RTE_TARGET
</pre></div>
</div>
<p>编译完成后，mybuild目录内容为:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>x86_64-native-linuxapp-gcc
├── .config  # 针对此target生成的配置文件
├── app      # 生成的自带应用程序
├── build    # 编译期间的临时文件
├── include  # 头文件（链接）
├── kmod     # 生成的内核驱动
├── lib      # 生成的dpdk库文件
└── Makefile # 生成的Makefile
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>9.3.2. 编译外部程序<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>假设外部程序源码在/home/zzq/helloworld目录。
在此目录下的Makefile中，需要包含dpdk的一些.mk文件，如$RTE_SDK/mk/rte.vas.mk，$RTE_SDK/mk/rte.app.mk等。具体见
<a class="reference external" href="http://dpdk.org/doc/guides/prog_guide/build_app.html">Building Your Own Application</a></p>
<p>首先确保设置了RTE_SDK和RTE_TARGET环境变量:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">RTE_SDK</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">zzq</span><span class="o">/</span><span class="n">dpdk</span><span class="o">-</span><span class="n">stable</span><span class="o">-</span><span class="mf">16.07</span><span class="o">.</span><span class="mi">2</span>
<span class="n">export</span> <span class="n">RTE_TARGET</span><span class="o">=</span><span class="n">x86_64</span><span class="o">-</span><span class="n">native</span><span class="o">-</span><span class="n">linuxapp</span><span class="o">-</span><span class="n">gcc</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">zzq</span><span class="o">/</span><span class="n">helloworld</span>
<span class="n">make</span>
</pre></div>
</div>
<p>编译完成后，生成的文件位于/home/zzq/helloworld/build目录。Makefile写法之类可以参考$RTE_SDK/examples目录中的各示例。</p>
</div>
</div>
<div class="section" id="dpdk-makefile">
<h2>9.4. dpdk Makefile介绍<a class="headerlink" href="#dpdk-makefile" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id7">
<h3>9.4.1. 一般规则<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>dpdk Makefile一般都是遵循以下方案：</p>
<ol class="arabic simple">
<li>在开头include $(RTE_SDK)/mk/rte.vars.mk</li>
<li>定义某些特定变量</li>
<li>根据需求，include $(RTE_SDK)mk/rte.XYZ.mk，XYZ可能是app,lib,extlib,obj等等，取决于要编译的目标文件类型</li>
<li>包含用户自定义的规则和变量</li>
</ol>
<p>以下是一个极简示例（取自examples/helloworld）:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ifeq ($(RTE_SDK),)
$(error &quot;Please define RTE_SDK environment variable&quot;)
endif

# Default target, can be overriden by command line or environment
RTE_TARGET ?= x86_64-native-linuxapp-gcc

include $(RTE_SDK)/mk/rte.vars.mk

# binary name
APP = helloworld

# all source are stored in SRCS-y
SRCS-y := main.c

CFLAGS += -O3
CFLAGS += $(WERROR_FLAGS)

include $(RTE_SDK)/mk/rte.extapp.mk
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3>9.4.2. 类型<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>根据所包含的.mk文件的不同，Makefile有不同的角色。不可能用同一个Makefile编译库和应用程序，而必须得使用2个Makefile。</p>
<p>用户的Makefile都应包含rte.vars.mk。</p>
<div class="section" id="id9">
<h4>9.4.2.1. 应用程序<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>以下Makefile用于生成二进制程序：</p>
<ul class="simple">
<li>rte.app.mk: dpdk包含的应用程序</li>
<li>rte.extapp.mk: 外部应用程序</li>
<li>rte.hostapp.mk: 编译dpdk所需的工具</li>
</ul>
</div>
<div class="section" id="id10">
<h4>9.4.2.2. 库<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>rte.lib.mk: dpdk库</li>
<li>rte.extlib.mk: 外部库</li>
<li>rte.hostlib.mk: dpdk中的host库</li>
</ul>
</div>
<div class="section" id="install">
<h4>9.4.2.3. install<a class="headerlink" href="#install" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>rte.install.mk: 不编译任何东西，只用于创建链接或将文件拷贝到安装目录</li>
</ul>
</div>
<div class="section" id="id11">
<h4>9.4.2.4. 内核模块<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>rte.module.mk: 编译dpdk中的内核模块</li>
</ul>
</div>
<div class="section" id="objects">
<h4>9.4.2.5. objects<a class="headerlink" href="#objects" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>rte.obj.mk: 将编译dpdk生成的多个.o文件合并成一个</li>
<li>rte.extobj.mk: 将编译外部代码生成的多个.o文件合并成一个</li>
</ul>
</div>
<div class="section" id="id12">
<h4>9.4.2.6. 杂项<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>rte.doc.mk: 编译dpdk文档</li>
<li>rte.gnuconfigure.mk: 编译基于configure的应用程序</li>
<li>rte.subdir.mk: 编译dpdk的多个子目录</li>
</ul>
</div>
</div>
<div class="section" id="id13">
<h3>9.4.3. 常用变量<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><strong>RTE_SDK</strong> dpdk源码主目录的绝对路径</li>
<li><strong>RTE_SRCDIR</strong> 源码根目录，编译dpdk时等于$RTE_SDK，编译外部程序时指向外部程序源码的根目录</li>
<li><strong>RTE_OUTPUT</strong> 输出文件路径，默认是$(RTE_SDK)/build，但可以通过命令行中的 <code class="docutils literal"><span class="pre">O=</span></code> 选项来指定</li>
<li><strong>RTE_TARGET</strong> 用于识别当前编译目标的字符串，格式是 <code class="docutils literal"><span class="pre">arch-machine\</span>
<span class="pre">-execenv-toolchain</span></code></li>
<li><strong>RTE_SDK_BIN</strong> 引用$(RTE_SDK)/$(RTE_TARGET)。注意，编译基于dpdk的外部程序时会通过$RTE_SDK_BIN来引用dpdk库，因此编译dpdk时，最好通过O=$(RTE_TARGET)指定输出目录到$(RTE_TARGET)，而不是&#8221;build&#8221;,&#8221;mybuild&#8221;等目录</li>
<li><strong>RTE_ARCH</strong> 定义CPU架构(i686,x86_64等)，它与CONFIG_RTE_ARCH值相同，但没有两边的&#8221;号</li>
<li><strong>RTE_MACHINE</strong> 定义machine(native, armv8a等)，它与CONFIG_RTE_MACHINE值相同，但没有两边的&#8221;号</li>
<li><strong>RTE_TOOLCHAIN</strong> 定义编译工具链(gcc,icc,clang等)，它与CONFIG_RTE_TOOLCHAIN值相同，但没有两边的&#8221;号</li>
<li><strong>RTE_EXEC_ENV</strong> 定义执行环境(linuxapp,bsdapp等)，它与CONFIG_RTE_EXEC_ENV值相同，但没有两边的&#8221;号</li>
<li><strong>RTE_KERNELDIR</strong> 包含用于编译内核模块的内核源码的绝对路径，默认是/lib/modules/$(shell uname -r)/build，当目标机器也是编译机器时是没问题的，否则要在目标机器上重新编译</li>
<li><strong>RTE_DEVEL_BUILD</strong> Stricter options (stop on warning). It defaults to y in a git tree.</li>
</ul>
</div>
<div class="section" id="makefile">
<h3>9.4.4. 仅可以在Makefile中设置的变量<a class="headerlink" href="#makefile" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><strong>VPATH</strong> 源码搜索路径列表，RTE_SRCDIR默认会包含在其中</li>
<li><strong>CFLAGS</strong> C编译选项</li>
<li><strong>LDFLAGS</strong> 链接选项</li>
<li><strong>ASFLAGS</strong> 汇编选项</li>
<li><strong>CPPFLAGS</strong> C预处理器选项（仅用于汇编.S文件）</li>
<li><strong>LDLIBS</strong> 要链接的库列表</li>
<li><strong>SRC-y</strong> 源文件列表（.c,.S或.o），这些文件必须在VPATH中</li>
<li><strong>INSTALL-y-$(INSTPATH)</strong> 要安装到$(INSTPATH)中的文件列表，这些文件必须在VPATH中，且会被拷贝到$(RTE_OUTPUT)/$(INSTPATH)</li>
<li><strong>SYMLINK-y-$(INSTPATH)</strong> 要安装到$(INSTPATH)中的文件列表，这些文件必须在VPATH中，且会被符号链接到$(RTE_OUTPUT)/$(INSTPATH)</li>
<li><strong>PREBUILD</strong> 编译之前需要执行的动作</li>
<li><strong>POSTBUILD</strong> 主要编译之后需要执行的动作</li>
<li><strong>PREINSTALL</strong> 安装之前需要执行的动作</li>
<li><strong>POSTINSTALL</strong>  安装之后需要执行的动作</li>
<li><strong>PRECLEAN</strong> 在清理之前需要执行的动作</li>
<li><strong>POSTCLEAN</strong> 在清理之后需要执行的动作</li>
<li><strong>DEPDIR-y</strong> 仅用于确定当前目录的编译是否依赖其他目录的编译，并行编译需要此变量</li>
</ul>
</div>
<div class="section" id="id14">
<h3>9.4.5. 仅可以在命令行中设置的变量<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p>见 <a class="reference internal" href="#root-makefile-help"><span class="std std-ref">根Makefile介绍</span></a> 和 <a class="reference external" href="http://dpdk.org/doc/guides/prog_guide/ext_app_lib_make_help.html">External Application/Library Makefile Help </a> 。</p>
<ul>
<li><p class="first"><strong>WERROR_CFLAGS</strong> 默认设置为依赖于编译器的某特定值，推荐用法如:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>CFLAGS += $(WERROR_CFLAGS)
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="id15">
<h3>9.4.6. 可以在Makefile或命令行中设置的变量<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><strong>CFLAGS_my_file.o</strong> 额外的my_file.c的C编译选项</li>
<li><strong>LDFLAGS_my_app</strong> 额外的my_app的链接选项</li>
<li><strong>EXTRA_CFLAGS</strong> 编译时添加到CFLAGS之后</li>
<li><strong>EXTRA_LDFLAGS</strong> 链接时添加到LDFLAGS之后</li>
<li><strong>EXTRA_LDLIBS</strong> 链接时添加到LDLIBS之后</li>
<li><strong>EXTRA_ASFLAGS</strong> 汇编时添加到ASFLAGS之后</li>
<li><strong>EXTRA_CPPFLAGS</strong> 添加到CPPFLAGS之后</li>
</ul>
</div>
</div>
<div class="section" id="root-makefile-help">
<span id="id16"></span><h2>9.5. 根Makefile介绍<a class="headerlink" href="#root-makefile-help" title="Permalink to this headline">¶</a></h2>
<p>dpdk编译系统提供了一个包含多个target的根Makefile，这些target包括config, build, test, install及其他。此Makefile应该是&lt;RTE_SDK&gt;/mk/rte.sdkroot.mk。</p>
<div class="section" id="config-target">
<h3>9.5.1. config target<a class="headerlink" href="#config-target" title="Permalink to this headline">¶</a></h3>
<p>编译此target必须通过 <code class="docutils literal"><span class="pre">T=</span></code> 指定target名称，所有可用的target名称见&lt;RTE_SDK&gt;/config/defconfig_XXX。还可以通过 <code class="docutils literal"><span class="pre">O=</span></code> 指定输出目录，默认目录是build。示例:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>export RTE_TARGET=x86_64-native-linuxapp-gcc
make config T=$RTE_TARGET O=$RTE_TARGET
</pre></div>
</div>
<p>完成后，将在输出目录创建配置文件和Makefile等。</p>
</div>
<div class="section" id="build-target">
<h3>9.5.2. build target<a class="headerlink" href="#build-target" title="Permalink to this headline">¶</a></h3>
<p>build target也支持输出目录的可选项，即 <code class="docutils literal"><span class="pre">O=</span></code> ，默认目录是build。</p>
<ul class="simple">
<li>all, 或仅make 在make config创建的输出目录中编译dpdk</li>
<li>clean 清理</li>
<li>%_sub 仅编译某个子目录。例： <code class="docutils literal"><span class="pre">make</span> <span class="pre">lib/librte_eal_sub</span> <span class="pre">O=$RTE_TARGET</span></code></li>
<li>%_clean 仅清理某个子目录。例： <code class="docutils literal"><span class="pre">make</span> <span class="pre">lib/librte_eal_clean</span> <span class="pre">O=$RTE_TARGET</span></code></li>
</ul>
<p>以上target都可以带 <code class="docutils literal"><span class="pre">O=</span></code> 选项。</p>
</div>
<div class="section" id="install-target">
<h3>9.5.3. install target<a class="headerlink" href="#install-target" title="Permalink to this headline">¶</a></h3>
<p>安装编译后的文件。例： <code class="docutils literal"><span class="pre">make</span> <span class="pre">install</span> <span class="pre">DESTDIR=myinstall</span> <span class="pre">prefix=/usr</span></code></p>
<p>注意需要指定DESTDIR。</p>
</div>
<div class="section" id="test-target">
<h3>9.5.4. test target<a class="headerlink" href="#test-target" title="Permalink to this headline">¶</a></h3>
<p>启动自动测试（需要在编译前将config/common_base中的 CONFIG_RTE_APP_TEST改为y)。例： <code class="docutils literal"><span class="pre">make</span> <span class="pre">test</span> <span class="pre">O=$RTE_TARGET</span></code></p>
</div>
<div class="section" id="target">
<h3>9.5.5. 文档target<a class="headerlink" href="#target" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>doc 生成API和指南文档</li>
<li>doc-api-html 生成html格式的API文档(基于Doxygen)</li>
<li>doc-guides-html 生成html格式的指南文档</li>
<li>doc-guides-pdf 生成pdf格式的指南文档</li>
</ul>
</div>
<div class="section" id="deps-target">
<h3>9.5.6. deps target<a class="headerlink" href="#deps-target" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">depdirs 此target由make config隐式调用，用户一般不需要显式调用，除非Makefile中的DEPDIRS-y变量发生了变化。执行后会生成$RTE_OUTPUT/.depdirs文件。</p>
</li>
<li><p class="first">depgraph 此命令生成依赖项的dot graph，可用于调试循环引用问题。</p>
<blockquote>
<div><p>示例:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>make depgraph O=$RTE_TARGET &gt; /tmp/graph.dot &amp;&amp; dotty /tmp/graph.dot
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<p>有关dot和dotty可参考： <a class="reference external" href="http://hoagland.org/Dot.html">http://hoagland.org/Dot.html</a></p>
</div>
<div class="section" id="id17">
<h3>9.5.7. 杂项target<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>help 显示编译帮助</li>
</ul>
</div>
<div class="section" id="id18">
<h3>9.5.8. 其他命令行变量<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><strong>V=</strong> verbose模式（V=y），显示完整的编译命令，包括一些中间命令</li>
<li><strong>D=</strong> 依赖性调试</li>
<li>EXTRA_CFLAGS=, EXTRA_LDFLAGS=, EXTRA_LDLIBS=, EXTRA_ASFLAGS=, EXTRA_CPPFLAGS=</li>
<li><strong>CROSS=</strong> Specify a cross toolchain header that will prefix all gcc/binutils applications. This only works when using gcc.</li>
</ul>
</div>
<div class="section" id="debug">
<h3>9.5.9. 编译Debug版本<a class="headerlink" href="#debug" title="Permalink to this headline">¶</a></h3>
<p>修改EXTRA_CFLAGS环境变量即可:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">EXTRA_CFLAGS</span><span class="o">=</span><span class="s1">&#39;-O0 -g&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="abi">
<h2>9.6. ABI管理<a class="headerlink" href="#abi" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id19">
<h3>9.6.1. 什么是ABI<a class="headerlink" href="#id19" title="Permalink to this headline">¶</a></h3>
<p>XXX</p>
</div>
<div class="section" id="dpdk-abi">
<h3>9.6.2. DPDK ABI策略<a class="headerlink" href="#dpdk-abi" title="Permalink to this headline">¶</a></h3>
<p>XXX 见 <a class="reference external" href="http://dpdk.org/doc/guides/contributing/versioning.html#the-dpdk-abi-policy">DPDK ABI policy</a></p>
</div>
<div class="section" id="id20">
<h3>9.6.3. ABI宏及示例<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h3>
<p>库中的符号（symbol）不仅提供了API，还提供了函数名、返回值和参数这些调用约定。有时候在新版本中需要修改这些函数，此时，应在一段时间内与旧版本保持向后兼容。</p>
<p>头文件 <code class="docutils literal"><span class="pre">lib/librte_compat/rte_compat.h</span></code> 提供了向后兼容所需要的宏，这些宏与文件 <code class="docutils literal"><span class="pre">rte_&lt;library&gt;_version.map</span></code> 结合使用，以支持在同一个动态库中提供同一符号的多个版本，这样一来，依赖此动态库的旧版本的程序就不需要重新编译。</p>
<p>这些宏包括：</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">VERSION_SYMBOL(b,</span> <span class="pre">e,</span> <span class="pre">n)</span></code> 创建一个符号版本表项，绑定版本化符号<code class="docutils literal"><span class="pre">b&#64;DPDK_n</span></code> 到内部函数 <code class="docutils literal"><span class="pre">b_e</span></code></li>
<li><code class="docutils literal"><span class="pre">BIND_DEFAULT_SYMBOL(b,</span> <span class="pre">e,</span> <span class="pre">n)</span></code> 创建一个符号版本项，指导链接器将符号 <code class="docutils literal"><span class="pre">b</span></code> 绑定到内部函数 <code class="docutils literal"><span class="pre">b_e</span></code></li>
<li><code class="docutils literal"><span class="pre">MAP_STATIC_SYMBOL(f,</span> <span class="pre">p)</span></code> 声明原型 <code class="docutils literal"><span class="pre">f</span></code> ，并将它映射到完整函数
<code class="docutils literal"><span class="pre">p</span></code> 。这样的话，若某符号版本化（有多个版本），它仍可被映射回公共符号名</li>
</ul>
<p>下面是一些实例。</p>
<div class="section" id="api">
<h4>9.6.3.1. 更新API<a class="headerlink" href="#api" title="Permalink to this headline">¶</a></h4>
<p>假设老版本函数为</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Create an acl context object for apps to manipulate</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rte_acl_ctx</span> <span class="o">*</span>
<span class="nf">rte_acl_create</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rte_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>现在需要修改此API，给acl context设置debug标志：</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Create an acl context object for apps to manipulate</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">rte_acl_ctx</span> <span class="o">*</span>
<span class="nf">rte_acl_create</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">rte_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>如果不使用ABI宏直接编译，那么链接此动态库的旧程序将不得不修改代码。而使用ABI宏可以让多个函数映射到同一符号，让新版动态库保持向后兼容，旧程序不需要修改代码。</p>
<p>首先需要修改此库对应的.map文件，原本的文件内容如下（rte_acl_version.map）:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DPDK_2</span><span class="o">.</span><span class="mi">0</span> <span class="p">{</span>
    <span class="k">global</span><span class="p">:</span>

    <span class="n">rte_acl_add_rules</span><span class="p">;</span>
    <span class="n">rte_acl_build</span><span class="p">;</span>
    <span class="n">rte_acl_classify</span><span class="p">;</span>
    <span class="n">rte_acl_classify_alg</span><span class="p">;</span>
    <span class="n">rte_acl_classify_scalar</span><span class="p">;</span>
    <span class="n">rte_acl_create</span><span class="p">;</span>
    <span class="n">rte_acl_dump</span><span class="p">;</span>
    <span class="n">rte_acl_find_existing</span><span class="p">;</span>
    <span class="n">rte_acl_free</span><span class="p">;</span>
    <span class="n">rte_acl_ipv4vlan_add_rules</span><span class="p">;</span>
    <span class="n">rte_acl_ipv4vlan_build</span><span class="p">;</span>
    <span class="n">rte_acl_list_dump</span><span class="p">;</span>
    <span class="n">rte_acl_reset</span><span class="p">;</span>
    <span class="n">rte_acl_reset_rules</span><span class="p">;</span>
    <span class="n">rte_acl_set_ctx_classify</span><span class="p">;</span>

    <span class="n">local</span><span class="p">:</span> <span class="o">*</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>需要修改为:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DPDK_2</span><span class="o">.</span><span class="mi">0</span> <span class="p">{</span>
    <span class="k">global</span><span class="p">:</span>

    <span class="n">rte_acl_add_rules</span><span class="p">;</span>
    <span class="n">rte_acl_build</span><span class="p">;</span>
    <span class="n">rte_acl_classify</span><span class="p">;</span>
    <span class="n">rte_acl_classify_alg</span><span class="p">;</span>
    <span class="n">rte_acl_classify_scalar</span><span class="p">;</span>
    <span class="n">rte_acl_create</span><span class="p">;</span>
    <span class="n">rte_acl_dump</span><span class="p">;</span>
    <span class="n">rte_acl_find_existing</span><span class="p">;</span>
    <span class="n">rte_acl_free</span><span class="p">;</span>
    <span class="n">rte_acl_ipv4vlan_add_rules</span><span class="p">;</span>
    <span class="n">rte_acl_ipv4vlan_build</span><span class="p">;</span>
    <span class="n">rte_acl_list_dump</span><span class="p">;</span>
    <span class="n">rte_acl_reset</span><span class="p">;</span>
    <span class="n">rte_acl_reset_rules</span><span class="p">;</span>
    <span class="n">rte_acl_set_ctx_classify</span><span class="p">;</span>

    <span class="n">local</span><span class="p">:</span> <span class="o">*</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">DPDK_2</span><span class="o">.</span><span class="mi">1</span> <span class="p">{</span>
    <span class="k">global</span><span class="p">:</span>
    <span class="n">rte_acl_create</span><span class="p">;</span>

<span class="p">}</span> <span class="n">DPDK_2</span><span class="o">.</span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>增加的部分告诉链接器新增了一个版本节点（version node）DPDK_2.1，它包含符号rte_acl_create，并继承节点DPDK_2.0的符号。当DPDK被编译为动态库时，此列表会直接翻译成导出符号表。</p>
<p>接下来，需要在代码中指定哪个版本映射哪个rte_acl_create。首先，需要改变原函数的定义，使其命名唯一且不和公用符号名冲突:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">rte_acl_ctx</span> <span class="o">*</span>
<span class="o">-</span><span class="n">rte_acl_create</span><span class="p">(</span><span class="n">const</span> <span class="n">struct</span> <span class="n">rte_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="o">+</span><span class="n">rte_acl_create_v20</span><span class="p">(</span><span class="n">const</span> <span class="n">struct</span> <span class="n">rte_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">size_t</span> <span class="n">sz</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">rte_acl_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>注意符号的基本名称（指的应该是rte_acl_create_v20中的rte_acl_create前缀）保持不变，这对用于符号版本化的宏有好处。接着，把新符号名映射到版本节点2.0中的原始符号名。紧接着此函数的定义，添加一行代码:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">VERSION_SYMBOL</span><span class="p">(</span><span class="n">rte_acl_create</span><span class="p">,</span> <span class="n">_v20</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</pre></div>
</div>
<p>记得把rte_compat.h头文件包含到.c源码文件中。上面的宏指导链接器创建一个新符号 <code class="docutils literal"><span class="pre">rte_acl_create&#64;DPDK_2.0</span></code> ，它匹配老版本中的符号，但指向上一步我们新命名的函数。到此为止，已经把原始的rte_acl_create符号映射到原始函数，只不过改了一个新名字。</p>
<p>然后，需要创建符号的2.1版本。实现的新版函数使用一个新的函数名，带不同的后缀:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">rte_acl_ctx</span> <span class="o">*</span>
<span class="n">rte_acl_create_v21</span><span class="p">(</span><span class="n">const</span> <span class="n">struct</span> <span class="n">rte_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="nb">int</span> <span class="n">debug</span><span class="p">);</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">rte_acl_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">rte_acl_create_v20</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>

    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">ctx</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>同样地，需要把此函数映射到符号 <code class="docutils literal"><span class="pre">rte_acl_create&#64;DPDK_2.1</span></code> 。修改此API原型所在的头文件，添加版本宏，通知调用此函数的程序在重新链接时，默认的rte_acl_create符号应指向新版本函数:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">rte_acl_ctx</span> <span class="o">*</span>
<span class="o">-</span><span class="n">rte_acl_create</span><span class="p">(</span><span class="n">const</span> <span class="n">struct</span> <span class="n">rte_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>
<span class="o">+</span><span class="n">rte_acl_create</span><span class="p">(</span><span class="n">const</span> <span class="n">struct</span> <span class="n">rte_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="nb">int</span> <span class="n">debug</span><span class="p">);</span>
<span class="o">+</span><span class="n">BIND_DEFAULT_SYMBOL</span><span class="p">(</span><span class="n">rte_acl_create</span><span class="p">,</span> <span class="n">_v21</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">);</span>
</pre></div>
</div>
<p>BIND_DEFAULT_SYMBOL宏显式地告诉包含此头文件的程序链接函数rte_acl_create_v21并对其应用版本节点DPDK_2.1。这种方法比重新实现原符号名更显式和灵活。</p>
<p>最后，以上步骤只适用于动态链接，静态链接并没有版本化的概念，以上步骤会导致静态编译时因为找不到 <code class="docutils literal"><span class="pre">rte_acl_create</span></code> 这个符号而失败。</p>
<p>要解决此问题，可以用MAP_STATIC_SYMBOL宏将指定函数映射到公用符号。一般来说要映射的特定函数就是最新版本的函数。因此，回到函数定义所在的.c文件，在 <code class="docutils literal"><span class="pre">rte_acl_create_v21</span></code> 定义之后，紧接着添加宏代码:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">rte_acl_ctx</span> <span class="o">*</span>
<span class="n">rte_acl_create_v21</span><span class="p">(</span><span class="n">const</span> <span class="n">struct</span> <span class="n">rte_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="nb">int</span> <span class="n">debug</span><span class="p">)</span>
<span class="p">{</span>
     <span class="o">...</span>
<span class="p">}</span>
<span class="n">MAP_STATIC_SYMBOL</span><span class="p">(</span><span class="n">struct</span> <span class="n">rte_acl_ctx</span> <span class="o">*</span><span class="n">rte_acl_create</span><span class="p">(</span><span class="n">const</span> <span class="n">struct</span> \
<span class="n">rte_acl_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="nb">int</span> <span class="n">debug</span><span class="p">),</span> <span class="n">rte_acl_create_v21</span><span class="p">);</span>
</pre></div>
</div>
<p>这告诉编译器在编译静态库时，把对符号 <code class="docutils literal"><span class="pre">rte_acl_create</span></code> 的调用链接到 <code class="docutils literal"><span class="pre">rte_acl_create_v21</span></code> 。</p>
<p>完成后，编译之后的新版本动态库，将含有2个版本的rte_acl_create，其中DPDK_2.0旧版本用于之前编译的用户程序，DPDK_2.1新版本用于未来编译的用户程序。</p>
</div>
</div>
<div class="section" id="id21">
<h3>9.6.4. 验证ABI<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h3>
<p>&lt;RTE_SDK&gt;/scripts目录中包含一个名为 <code class="docutils literal"><span class="pre">validate-abi.sh</span></code> 的脚本工具，
可用于验证DPDK ABI（基于Linux ABI Compliance Checker）。</p>
<p>详见：
<a class="reference external" href="http://dpdk.org/doc/guides/contributing/versioning.html#running-the-abi-validator">http://dpdk.org/doc/guides/contributing/versioning.html#running-the-abi-validator</a></p>
</div>
</div>
<div class="section" id="v16-07-2">
<h2>9.7. 实例：将v16.07.2编译为单个动态库<a class="headerlink" href="#v16-07-2" title="Permalink to this headline">¶</a></h2>
<p>dpdk从某个版本（可能是16.04）起，编译系统取消了对“编译成一个动态库”的支持。如果还需要将dpdk（除内核驱动以外）编译成单个的.so文件，需要对编译系统的某些文件做一些修改。</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">以下描述只针对编译单个动态库的需求，如果有其他编译需求,
请参考相关文档</p>
</div>
<div class="section" id="config-common-base">
<h3>9.7.1. config/common_base<a class="headerlink" href="#config-common-base" title="Permalink to this headline">¶</a></h3>
<p>修改:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">CONFIG_RTE_BUILD_SHARED_LIB</span><span class="o">=</span><span class="n">y</span>
</pre></div>
</div>
<p>添加:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">CONFIG_RTE_BUILD_COMBINE_LIBS</span><span class="o">=</span><span class="n">y</span>
<span class="n">CONFIG_RTE_LIBNAME</span><span class="o">=</span><span class="n">intel_dpdk</span>
</pre></div>
</div>
</div>
<div class="section" id="mk-rte-lib-mk">
<h3>9.7.2. mk/rte.lib.mk<a class="headerlink" href="#mk-rte-lib-mk" title="Permalink to this headline">¶</a></h3>
<p>在 <code class="docutils literal"><span class="pre">-include</span> <span class="pre">.$(LIB).cmd</span></code> 之前，添加:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ifeq ($(CONFIG_RTE_BUILD_SHARED_LIB),n)
O_TO_C = $(AR) crus $(LIB_ONE) $(OBJS-y)
O_TO_C_STR = $(subst &#39;,&#39;\&#39;&#39;,$(O_TO_C)) #&#39;# fix syntax highlight
O_TO_C_DISP = $(if $(V),&quot;$(O_TO_C_STR)&quot;,&quot;  AR_C $(@)&quot;)
O_TO_C_DO = @set -e; \
    $(lib_dir) \
    $(copy_obj)
else
O_TO_C = $(LD) -shared $(OBJS-y) -o $(LIB_ONE)
O_TO_C_STR = $(subst &#39;,&#39;\&#39;&#39;,$(O_TO_C)) #&#39;# fix syntax highlight
O_TO_C_DISP = $(if $(V),&quot;$(O_TO_C_STR)&quot;,&quot;  LD_C $(@)&quot;)
O_TO_C_DO = @set -e; \
    $(lib_dir) \
    $(copy_obj)
endif

copy_obj = cp -f $(OBJS-y) $(RTE_OUTPUT)/build/lib;
lib_dir = [ -d $(RTE_OUTPUT)/lib ] || mkdir -p $(RTE_OUTPUT)/lib;
</pre></div>
</div>
<p>$(copy_obj)把编译成的.o文件拷贝到$(RTE_OUTPUT)/build/lib目录。</p>
<p>在 <code class="docutils literal"><span class="pre">ifeq</span> <span class="pre">($(CONFIG_RTE_BUILD_SHARED_LIB),</span> <span class="pre">y)</span></code> 判断语句块的第一个else前，添加:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ifeq ($(CONFIG_RTE_BUILD_COMBINE_LIBS),y)
    $(if $(or \
        $(file_missing),\
        $(call cmdline_changed,$(O_TO_C_STR)),\
        $(depfile_missing),\
        $(depfile_newer)),\
        $(O_TO_C_DO))
endif
</pre></div>
</div>
<p>在这语句块结束的最后一个 <code class="docutils literal"><span class="pre">endif</span></code> 前，添加:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ifeq ($(CONFIG_RTE_BUILD_COMBINE_LIBS),y)
    $(if $(or \
        $(file_missing),\
        $(call cmdline_changed,$(O_TO_C_STR)),\
        $(depfile_missing),\
        $(depfile_newer)),\
        $(O_TO_C_DO))
endif
</pre></div>
</div>
</div>
<div class="section" id="mk-rte-combinedlib-mk">
<h3>9.7.3. mk/rte.combinedlib.mk<a class="headerlink" href="#mk-rte-combinedlib-mk" title="Permalink to this headline">¶</a></h3>
<p>首先要包含rte.build-pre.mk:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>include $(RTE_SDK)/mk/internal/rte.build-pre.mk
</pre></div>
</div>
<p>修改输出库文件名，删除:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">RTE_LIBNAME</span> <span class="p">:</span><span class="o">=</span> <span class="n">dpdk</span>
</pre></div>
</div>
<p>因为库名称在common_base文件中配置了。修改:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>COMBINEDLIB := lib$(CONFIG_RTE_LIBNAME)$(EXT)
</pre></div>
</div>
<p>在LIBS后面添加:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>OBJS = $(wildcard $(RTE_OUTPUT)/build/lib/*.o)
CPU_LDFLAGS += --version-script=$(SRCDIR)/lib/libdpdk.map
</pre></div>
</div>
<p>之后需要链接OBJS，libdpdk.map是上文说到的版本控制脚本。</p>
<p>在 <code class="docutils literal"><span class="pre">all:</span> <span class="pre">FORCE</span></code> 前添加:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ifeq ($(LINK_USING_CC),1)
# Override the definition of LD here, since we&#39;re linking with CC
LD := $(CC) $(CPU_CFLAGS)
O_TO_S = $(LD) $(call linkerprefix,$(CPU_LDFLAGS)) \
    -shared $(OBJS) -o $(RTE_OUTPUT)/lib/$(COMBINEDLIB)
else
O_TO_S = $(LD) $(CPU_LDFLAGS) \
    -shared $(OBJS) -o $(RTE_OUTPUT)/lib/$(COMBINEDLIB)
endif

O_TO_S_STR = $(subst &#39;,&#39;\&#39;&#39;,$(O_TO_S)) #&#39;# fix syntax highlight
O_TO_S_DISP = $(if $(V),&quot;$(O_TO_S_STR)&quot;,&quot;  LD $(@)&quot;)
O_TO_S_CMD = &quot;cmd_$@ = $(O_TO_S_STR)&quot;
O_TO_S_DO = @set -e; \
    echo $(O_TO_S_DISP); \
    $(O_TO_S)
</pre></div>
</div>
<p>修改all目标( <code class="docutils literal"><span class="pre">all:</span> <span class="pre">FORCE</span></code> 下一行）:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>all: FORCE
    $(O_TO_S_DO)
</pre></div>
</div>
</div>
<div class="section" id="mk-rte-app-mk">
<h3>9.7.4. mk/rte.app.mk<a class="headerlink" href="#mk-rte-app-mk" title="Permalink to this headline">¶</a></h3>
<p>此文件改动较大。首先在 <code class="docutils literal"><span class="pre">_LDLIBS-y</span> <span class="pre">+=</span> <span class="pre">-L$(RTE_SDK_BIN)/lib</span></code> 之后添加:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>_LDLIBS-$(CONFIG_RTE_BUILD_COMBINE_LIBS)    += -l$(CONFIG_RTE_LIBNAME)
_LDLIBS-y += -lm
_LDLIBS-y += -lpcap
</pre></div>
</div>
<p>之后，在 <code class="docutils literal"><span class="pre">_LDLIBS-y</span> <span class="pre">+=</span> <span class="pre">--whole-archive</span></code> 之前，修改为:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ifeq ($(CONFIG_RTE_BUILD_COMBINE_LIBS),n)

_LDLIBS-$(CONFIG_RTE_LIBRTE_DISTRIBUTOR)    += -lrte_distributor
_LDLIBS-$(CONFIG_RTE_LIBRTE_REORDER)        += -lrte_reorder
ifeq ($(CONFIG_RTE_EXEC_ENV_LINUXAPP),y)
_LDLIBS-$(CONFIG_RTE_LIBRTE_KNI)            += -lrte_kni
_LDLIBS-$(CONFIG_RTE_LIBRTE_IVSHMEM)        += -lrte_ivshmem
endif

_LDLIBS-$(CONFIG_RTE_LIBRTE_PIPELINE)       += -lrte_pipeline
_LDLIBS-$(CONFIG_RTE_LIBRTE_TABLE)          += -lrte_table
_LDLIBS-$(CONFIG_RTE_LIBRTE_PORT)           += -lrte_port
_LDLIBS-$(CONFIG_RTE_LIBRTE_TIMER)          += -lrte_timer
_LDLIBS-$(CONFIG_RTE_LIBRTE_HASH)           += -lrte_hash
_LDLIBS-$(CONFIG_RTE_LIBRTE_JOBSTATS)       += -lrte_jobstats
_LDLIBS-$(CONFIG_RTE_LIBRTE_LPM)            += -lrte_lpm
_LDLIBS-$(CONFIG_RTE_LIBRTE_POWER)          += -lrte_power
# librte_acl needs --whole-archive because of weak functions
_LDLIBS-$(CONFIG_RTE_LIBRTE_ACL)            += --whole-archive
_LDLIBS-$(CONFIG_RTE_LIBRTE_ACL)            += -lrte_acl
_LDLIBS-$(CONFIG_RTE_LIBRTE_ACL)            += --no-whole-archive
_LDLIBS-$(CONFIG_RTE_LIBRTE_PDUMP)          += -lrte_pdump
_LDLIBS-$(CONFIG_RTE_LIBRTE_IP_FRAG)        += -lrte_ip_frag
_LDLIBS-$(CONFIG_RTE_LIBRTE_METER)          += -lrte_meter
_LDLIBS-$(CONFIG_RTE_LIBRTE_SCHED)          += -lrte_sched
_LDLIBS-$(CONFIG_RTE_LIBRTE_VHOST)          += -lrte_vhost

endif # ! CONFIG_RTE_BUILD_COMBINE_LIBS
</pre></div>
</div>
<p>之后，在 <code class="docutils literal"><span class="pre">_LDLIBS-$(CONFIG_RTE_LIBRTE_KVARGS)</span> <span class="pre">+=</span> <span class="pre">-lrte_kvargs</span></code>
之前，添加:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ifeq ($(CONFIG_RTE_BUILD_SHARED_LIB),n)
# The static libraries do not know their dependencies.
# So linking with static library requires explicit dependencies.
_LDLIBS-$(CONFIG_RTE_LIBRTE_EAL)            += -lrt
_LDLIBS-$(CONFIG_RTE_LIBRTE_SCHED)          += -lm
_LDLIBS-$(CONFIG_RTE_LIBRTE_SCHED)          += -lrt
_LDLIBS-$(CONFIG_RTE_LIBRTE_METER)          += -lm
ifeq ($(CONFIG_RTE_LIBRTE_VHOST_NUMA),y)
_LDLIBS-$(CONFIG_RTE_LIBRTE_VHOST)          += -lnuma
endif
ifeq ($(CONFIG_RTE_LIBRTE_VHOST_USER),n)
_LDLIBS-$(CONFIG_RTE_LIBRTE_VHOST)          += -lfuse
endif
_LDLIBS-$(CONFIG_RTE_PORT_PCAP)             += -lpcap
endif # !CONFIG_RTE_BUILD_SHARED_LIB


_LDLIBS-y += --start-group
ifeq ($(CONFIG_RTE_BUILD_COMBINE_LIBS),n)
</pre></div>
</div>
<p>之后，在 <code class="docutils literal"><span class="pre">endif</span> <span class="pre">#</span> <span class="pre">CONFIG_RTE_LIBRTE_CRYPTODEV</span></code> 之后，
<code class="docutils literal"><span class="pre">_LDLIBS-y</span> <span class="pre">+=</span> <span class="pre">--no-whole-archive</span></code> 之前，添加:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>endif # !CONFIG_RTE_BUILD_SHARED_LIB
endif # ! CONFIG_RTE_BUILD_COMBINE_LIBS

_LDLIBS-y += $(EXECENV_LDLIBS)
_LDLIBS-y += --end-group
</pre></div>
</div>
<p>删除下面的:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>_LDLIBS-y += $(EXECENV_LDLIBS)
</pre></div>
</div>
<p>最后，将 <code class="docutils literal"><span class="pre">exe2cmd</span> <span class="pre">=</span> <span class="pre">$(strip</span> <span class="pre">$(call</span> <span class="pre">dotfile,$(patsubst</span> <span class="pre">%,%.cmd,$(1))))</span></code>
之后，<code class="docutils literal"><span class="pre">O_TO_EXE_STR</span> <span class="pre">=</span> <span class="pre">$(subst</span> <span class="pre">','\'',$(O_TO_EXE))</span> <span class="pre">#'#</span> <span class="pre">fix</span> <span class="pre">syntax</span> <span class="pre">highlight</span></code>
之前的内容，修改为:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>ifeq ($(LINK_USING_CC),1)
override EXTRA_LDFLAGS := $(call linkerprefix,$(EXTRA_LDFLAGS))
O_TO_EXE = $(CC) $(CFLAGS) $(LDFLAGS_$(@)) \
    -Wl,-Map=$(@).map,--cref -o $@ $(OBJS-y) $(call linkerprefix,$(LDFLAGS)) \
    $(EXTRA_LDFLAGS) $(call linkerprefix,$(LDLIBS))
else
O_TO_EXE = $(LD) $(LDFLAGS) $(LDFLAGS_$(@)) $(EXTRA_LDFLAGS) \
    -Map=$(@).map --cref -o $@ $(OBJS-y) $(LDLIBS)
endif
</pre></div>
</div>
</div>
<div class="section" id="libdpdk-map">
<h3>9.7.5. libdpdk.map<a class="headerlink" href="#libdpdk-map" title="Permalink to this headline">¶</a></h3>
<p>最后，需要提供一个版本控制脚本libdpdk.map，将它放在$RTE_SDK/lib目录中，
该文件内容为:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">DPDK_2</span><span class="o">.</span><span class="mi">0</span> <span class="p">{</span>

<span class="p">};</span>

<span class="n">DPDK_2</span><span class="o">.</span><span class="mi">1</span> <span class="p">{</span>

<span class="p">}</span> <span class="n">DPDK_2</span><span class="o">.</span><span class="mi">0</span><span class="p">;</span>

<span class="n">DPDK_2</span><span class="o">.</span><span class="mi">2</span> <span class="p">{</span>

<span class="p">}</span> <span class="n">DPDK_2</span><span class="o">.</span><span class="mi">1</span><span class="p">;</span>

<span class="n">DPDK_16</span><span class="o">.</span><span class="mi">04</span> <span class="p">{</span>

<span class="p">}</span> <span class="n">DPDK_2</span><span class="o">.</span><span class="mi">2</span><span class="p">;</span>

<span class="n">DPDK_16</span><span class="o">.</span><span class="mi">07</span> <span class="p">{</span>

<span class="p">}</span> <span class="n">DPDK_16</span><span class="o">.</span><span class="mi">04</span><span class="p">;</span>
</pre></div>
</div>
<p>附： <a class="reference external" href="./dpdk16.07_patch">patch文件</a></p>
</div>
</div>
<div class="section" id="id22">
<h2>9.8. 参考<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h2>
<table class="docutils citation" frame="void" id="dpdk-prog-guide-source-org" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[dpdk_prog_guide_source_org]</td><td><a class="reference external" href="http://dpdk.org/doc/guides/prog_guide/source_org.html">DPDK Programmer&#8217;s Guide - Source Organization </a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="dpdk-prog-guide-build-system" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[dpdk_prog_guide_build_system]</td><td><a class="reference external" href="http://dpdk.org/doc/guides/prog_guide/dev_kit_build_system.html">DPDK Programmer&#8217;s Guide - Development Kit Build System </a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="dpdk-prog-guide-makefile-help" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[dpdk_prog_guide_makefile_help]</td><td><a class="reference external" href="http://dpdk.org/doc/guides/prog_guide/dev_kit_root_make_help.html">DPDK Programmer&#8217;s Guide - Development Kit Root Makefile Help </a></td></tr>
</tbody>
</table>
<table class="docutils citation" frame="void" id="dpdk-contr-abi" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[dpdk_contr_abi]</td><td><a class="reference external" href="http://dpdk.org/doc/guides/contributing/versioning.html">DPDK Contributor&#8217;s Guidelines - Managing ABI updates </a></td></tr>
</tbody>
</table>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../netalgo/index.html" class="btn btn-neutral float-right" title="网络算法学" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="mbuf.html" class="btn btn-neutral" title="8. Mbuf" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Zhao Ziqing.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>